# Master Fix Plan: Critical Launch Blockers

> Generated by @prompt-builder on 2025-12-27
> Status: Ready for Execution
> Total Estimated Time: 9-19 hours (parallel execution reduces to ~6-12 hours)

## Executive Summary

Four critical issues identified during launch readiness verification blocking deployment. All issues are fixable with clear implementation paths. Priority order ensures fastest path to launch.

## Critical Issues Overview

| # | Issue | Priority | Severity | Time | Dependencies | Status |
|---|-------|----------|----------|------|--------------|--------|
| 1 | Middleware Edge Runtime Compatibility | CRITICAL | Complete Blocker | 2-4 hours | None | ‚ö†Ô∏è BLOCKING |
| 2 | Database Type Errors | CRITICAL | High | 1-2 hours | None | ‚ö†Ô∏è BLOCKING |
| 3 | Integration Test Failures | HIGH | High | 4-8 hours | #1, #2 | ‚ö†Ô∏è BLOCKING |
| 4 | Admin CMS Type Constraints | MEDIUM | Medium | 2-4 hours | #2 | ‚ö†Ô∏è BLOCKING |

## Issue #1: Middleware Edge Runtime Compatibility (CRITICAL)

### Summary
All protected routes return 500 errors due to CommonJS/ESM bundling conflict in Edge Runtime.

**Error:** `ReferenceError: exports is not defined in .next/server/supabase.js:9`

**Root Cause:** Middleware imports Supabase client from `@supabase/supabase-js` (CommonJS) but Edge Runtime requires ESM-only modules.

**Impact:** Complete blocker - no protected routes work (/dashboard, /requests, /messages, /profile)

### Recommended Agent
**@api-designer** with **Grok Code Fast 1** - Middleware, Edge Runtime, Supabase integration (fast for coding tasks)

### Implementation Approach
1. Create Edge-compatible Supabase client using `@supabase/ssr`
2. Refactor middleware to use new client
3. Update Webpack configuration if needed
4. Test all protected routes

### Acceptance Criteria
- Production build succeeds without middleware errors
- All protected routes load successfully when authenticated
- No `ReferenceError: exports is not defined` errors
- Middleware uses Edge Runtime (verified)

### Prompt File
`.prompts/critical-fixes/01-middleware-edge-runtime-fix.md`

---

## Issue #2: Database Type Errors (CRITICAL - Quick Win)

### Summary
130+ TypeScript errors, 80+ critical, due to stale database types.

**Errors:**
- `Property 'verification_status' does not exist on type 'never'`
- `Property 'is_admin' does not exist on type 'never'`

**Root Cause:** Database types out of sync with actual schema

**Impact:** Type checking broken, affects Dashboard, Profile, Requests, Auth callback, Admin routes

### Recommended Agent
**@api-designer** - Database schema, type generation

### Implementation Approach
1. Regenerate database types from current schema
2. Update imports and references
3. Run type check and fix remaining errors
4. Test key areas

### Acceptance Criteria
- TypeScript compilation passes (0 errors)
- All critical errors resolved
- Production build succeeds without type errors

### Prompt File
`.prompts/critical-fixes/02-database-types-regeneration.md`

---

## Issue #3: Integration Test Failures (HIGH)

### Summary
0% pass rate, 15 tests failing due to outdated Next.js Router mocking.

**Error:** `useRouter.mockReturnValue is not a function`

**Root Cause:** Test setup incompatible with Next.js 14 App Router

**Impact:** Cannot verify user journeys work end-to-end

### Recommended Agent
**@test-engineer** with **Grok Code Fast 1** - Test infrastructure, Next.js 14 App Router testing (optimized for test fixes)

### Implementation Approach
1. Analyze test setup and identify all failing tests
2. Fix Next.js 14 App Router mocks
3. Fix other Next.js 14 incompatibilities
4. Prioritize critical tests (auth, help requests, messaging)

### Acceptance Criteria
- All 15 integration tests pass (or as many as possible)
- Auth flow tests work: login ‚Üí dashboard
- Help request creation tests work
- Basic messaging tests work
- No `useRouter.mockReturnValue` errors

### Prompt File
`.prompts/critical-fixes/03-integration-test-fixes.md`

---

## Issue #4: Admin CMS Type Constraints (MEDIUM)

### Summary
30+ TypeScript errors in admin features due to missing CMS table types.

**Issue:** Type constraints not including new CMS tables (calendar_events, community_updates, etc.)

**Impact:** Admin features type-unsafe

### Recommended Agent
**@api-designer** - Database types, Zod validation

### Implementation Approach
1. Analyze admin type errors and identify missing tables
2. Check database schema for CMS tables
3. Update type constraints and create Zod schemas
4. Update admin components

### Acceptance Criteria
- All admin-related TypeScript errors resolved
- Type constraints include all CMS tables
- Zod schemas created for all CMS tables
- Admin features work without type errors

### Prompt File
`.prompts/critical-fixes/04-admin-cms-types-fix.md`

---

## Execution Strategy

### Phase 1: Immediate Parallel Fixes (Hours 1-4)

**Goal:** Unblock core functionality and type system

**Parallel Execution:**
- **Agent 1 (@api-designer):** Fix #1 Middleware Edge Runtime (2-4 hours)
- **Agent 2 (@api-designer):** Fix #2 Database Types (1-2 hours)

**Dependencies:** None between these two fixes

**Acceptance:**
- Middleware fixed and protected routes work
- Database types regenerated and type check passes

**Time:** 2-4 hours (parallel)

---

### Phase 2: Sequential Fixes (Hours 5-12)

**Goal:** Verify system works and complete admin features

**Sequential Execution:**

1. **Fix #3 Integration Tests** (@test-engineer)
   - **Blocks on:** Phase 1 completion (must have working middleware and types)
   - **Time:** 4-8 hours
   - **Focus:** Get 15 tests working, prioritize auth/help requests/messaging

2. **Fix #4 Admin CMS Types** (@api-designer)
   - **Blocks on:** Fix #2 (database types)
   - **Time:** 2-4 hours
   - **Can run in parallel:** Can run in parallel with #3 after Phase 1

**Time:** 4-8 hours (sequential), reduced to 4-6 hours if #3 and #4 run in parallel

---

### Critical Path

```
Phase 1 (Parallel):        [Fix #1] + [Fix #2]
                                 ‚Üì
Phase 2 (Sequential):      [Fix #3] ‚Üí [Fix #4]
                                 ‚Üì
                           ‚úÖ READY FOR LAUNCH
```

**Total Time:** 6-12 hours (parallel execution)

---

## Risk Assessment

### High Risks

1. **Middleware Edge Runtime complexity**
   - **Risk:** Edge Runtime may have other limitations not discovered yet
   - **Mitigation:** Thorough testing of all middleware functionality
   - **Fallback:** Use Node.js runtime (less ideal but functional)

2. **Integration test refactoring**
   - **Risk:** Some tests cannot be fixed without significant refactoring
   - **Mitigation:** Prioritize critical tests (auth, help requests, messaging)
   - **Fallback:** Document non-fixable tests, create plan for future work

### Medium Risks

3. **Database type regeneration**
   - **Risk:** Manual type edits will be overwritten
   - **Mitigation:** Check for manual edits before regeneration
   - **Fallback:** Apply targeted fixes instead of full regeneration

4. **Admin CMS types**
   - **Risk:** CMS table structure differs from assumptions
   - **Mitigation:** Verify database schema before creating types
   - **Fallback:** Update types iteratively based on errors

---

## Mitigation Strategies

### General Mitigation

1. **Incremental Testing:** Test each fix individually before moving to next
2. **Rollback Plan:** Keep backups of all files before modification
3. **Parallel Execution:** Run independent fixes in parallel to save time
4. **Prioritization:** Focus on critical user-facing functionality first

### Specific Mitigation

| Issue | Mitigation |
|-------|------------|
| #1 Middleware | Keep original middleware backed up, test thoroughly |
| #2 Database Types | Check for manual edits, document changes |
| #3 Integration Tests | Prioritize critical tests, document non-fixable tests |
| #4 Admin CMS Types | Verify schema before types, update incrementally |

---

## Success Criteria

### Minimum Viable Launch

‚úÖ **Must Have (Phase 1):**
- Middleware fixed - protected routes work
- Database types regenerated - type check passes
- Production build succeeds

‚úÖ **Should Have (Phase 2):**
- Auth flow tests pass
- Help request creation tests pass
- Basic messaging tests pass

‚úÖ **Nice to Have (Phase 2):**
- All 15 integration tests pass
- Admin features type-safe
- All admin CMS tables with Zod schemas

### Launch Readiness Checklist

- [ ] Middleware: All protected routes load successfully
- [ ] Types: TypeScript compilation passes (0 errors)
- [ ] Tests: Auth flow tests pass (login ‚Üí dashboard)
- [ ] Tests: Help request creation tests pass
- [ ] Tests: Basic messaging tests pass
- [ ] Build: Production build succeeds
- [ ] Admin: Admin features work (at least not breaking)
- [ ] Verification: Manual testing of key user flows

---

## Agent Assignment Summary

| Issue | Agent | Model | Phase | Dependencies |
|-------|-------|-------|-------|--------------|
| #1 Middleware | @api-designer | GLM-4.7 | 1 (Parallel) | None |
| #2 Database Types | @api-designer | GLM-4.7 | 1 (Parallel) | None |
| #3 Integration Tests | @test-engineer | GLM-4.7 | 2 (Sequential) | #1, #2 |
| #4 Admin CMS Types | @api-designer | GLM-4.7 | 2 (Parallel with #3) | #2 |

---

## Estimated Timeline

### Optimistic Scenario (Everything goes smoothly)
- **Phase 1:** 2 hours (parallel)
- **Phase 2:** 6 hours (sequential)
- **Total:** 8 hours

### Realistic Scenario (Some unexpected issues)
- **Phase 1:** 3 hours (parallel)
- **Phase 2:** 8 hours (sequential)
- **Total:** 11 hours

### Conservative Scenario (Major issues encountered)
- **Phase 1:** 4 hours (parallel)
- **Phase 2:** 10 hours (sequential)
- **Total:** 14 hours

---

## Recommended Execution Order

### Immediate Actions (Now)
1. ‚úÖ Review all prompt files for clarity and completeness
2. ‚úÖ Verify environment is ready (Supabase CLI, test runner, etc.)
3. ‚úÖ Create backups of critical files (middleware.ts, database.types.ts, test setup)

### Phase 1 Execution (Hours 1-4)
1. **Launch two agents in parallel:**
   - `@api-designer` with prompt: `.prompts/critical-fixes/01-middleware-edge-runtime-fix.md`
   - `@api-designer` with prompt: `.prompts/critical-fixes/02-database-types-regeneration.md`
2. **Verify Phase 1 completion:**
   - Middleware fixed and protected routes work
   - Database types regenerated and type check passes
   - Production build succeeds

### Phase 2 Execution (Hours 5-12)
1. **Launch agents for Phase 2:**
   - `@test-engineer` with prompt: `.prompts/critical-fixes/03-integration-test-fixes.md`
   - `@api-designer` with prompt: `.prompts/critical-fixes/04-admin-cms-types-fix.md` (can run in parallel after #2)
2. **Verify Phase 2 completion:**
   - Integration tests passing
   - Admin features type-safe
   - All critical issues resolved

### Launch Readiness Verification
1. Run full test suite
2. Perform manual testing of key user flows
3. Verify production build succeeds
4. Deploy to staging for final verification

---

## Rollback Strategy

If any fix causes issues:
1. **Stop further fixes:** Address the issue before proceeding
2. **Restore from backup:** Revert problematic file(s)
3. **Analyze the issue:** Understand why the fix failed
4. **Apply targeted fix:** Create a more conservative fix
5. **Re-test:** Verify the fix works before proceeding

**Rollback files to backup before each phase:**
- `middleware.ts` ‚Üí `middleware.ts.backup`
- `lib/database.types.ts` ‚Üí `lib/database.types.ts.backup`
- `tests/setup.ts` ‚Üí `tests/setup.ts.backup`
- Any admin type files ‚Üí respective backups

---

## Post-Fix Verification

### Automated Verification
```bash
# Type check
npm run type-check

# Build
npm run build

# Tests
npm test -- --run

# Coverage
npm run test:coverage
```

### Manual Verification
1. Login flow: /login ‚Üí /dashboard
2. Create help request: /requests ‚Üí create
3. Send message: /messages ‚Üí send message
4. Admin features: /admin ‚Üí create calendar event, community update
5. Protected routes: Verify all work when authenticated
6. Redirects: Verify unauthenticated users redirected to login

---

## Documentation Updates

After fixes are complete, document:
1. Middleware pattern for Edge Runtime (in docs/development/)
2. Database type regeneration process (in docs/database/)
3. Next.js 14 App Router testing patterns (in docs/testing/)
4. Admin CMS type constraints (in docs/database/)

---

## Questions & Clarifications

### For the Execution Team

1. **Should we aim for all 15 tests passing or focus on critical tests?**
   - Recommendation: Prioritize critical tests (auth, help requests, messaging), document any non-fixable tests

2. **Should admin CMS types be fixed before or after integration tests?**
   - Recommendation: Fix after database types (Phase 2), can run in parallel with integration tests

3. **What's the minimum launch criteria?**
   - Must have: Middleware fixed, database types regenerated, auth/help request tests passing
   - Should have: Basic messaging tests passing
   - Nice to have: All integration tests passing, admin features fully type-safe

4. **Should we proceed with deployment if integration tests can't all be fixed?**
   - Recommendation: If auth/help request/messaging tests pass, can proceed with deployment, create follow-up task for remaining tests

---

## Conclusion

All four critical issues have clear fix paths with reasonable time estimates. By executing fixes in parallel where possible and prioritizing critical functionality, we can resolve all blockers in **6-12 hours**.

**Recommended approach:**
1. Execute Phase 1 in parallel (middleware + database types)
2. Execute Phase 2 sequentially or semi-parallel (integration tests + admin CMS)
3. Verify all fixes work together
4. Perform launch readiness verification
5. Deploy to production

**Success is achievable within the estimated time frame.**

---

## Files Created

- `.prompts/critical-fixes/01-middleware-edge-runtime-fix.md` - Middleware fix prompt
- `.prompts/critical-fixes/02-database-types-regeneration.md` - Database types prompt
- `.prompts/critical-fixes/03-integration-test-fixes.md` - Integration tests prompt
- `.prompts/critical-fixes/04-admin-cms-types-fix.md` - Admin CMS types prompt
- `.prompts/critical-fixes/00-master-fix-plan.md` - This file (master plan)

**Ready for execution!** üöÄ
