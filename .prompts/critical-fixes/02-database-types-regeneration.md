# Fix Plan: Database Type Errors

> Generated by @prompt-builder on 2025-12-27
> Priority: CRITICAL (Quick Win)
> Estimated Fix Time: 1-2 hours

## Original Issue

**Errors:** 130+ TypeScript errors, 80+ critical
**Examples:**
- `Property 'verification_status' does not exist on type 'never'`
- `Property 'is_admin' does not exist on type 'never'`
**Impact:** Type checking broken, affects Dashboard, Profile, Requests, Auth callback, Admin routes
**Root Cause:** Database types likely out of sync with actual schema

## Root Cause Analysis

The database types (`lib/database.types.ts`) are generated from the Supabase schema using the Supabase CLI command:
```bash
supabase gen types typescript --project-id <id> > lib/database.types.ts
```

The types are out of sync because:
1. The schema has evolved (new tables, columns, constraints) but types weren't regenerated
2. Migrations have been applied but type generation wasn't run
3. The `database.types.ts` file may have manual edits that are now outdated

This is a straightforward fix - just regenerate the types from the current database schema.

## Target Agent

`@api-designer` - Database schema, type generation, Supabase integration

---

## Prompt

### Problem Statement

There are 130+ TypeScript errors because the database types are out of sync with the actual Supabase schema. The types need to be regenerated to match the current database structure.

### Technical Context

- **Current state:** `lib/database.types.ts` has stale type definitions
- **Expected state:** Types should match the current database schema
- **Generation command:** `supabase gen types typescript --project-id <id> > lib/database.types.ts`
- **Project ID:** Available in environment or can be extracted from config
- **Potential issue:** There's also `lib/database.types.new.ts` - may need to determine which is current

### Implementation Requirements

#### Phase 1: Analyze Current State (20 min)
1. Read `lib/database.types.ts` to understand the current type structure
2. Check if `lib/database.types.new.ts` exists and compare
3. Find the Supabase project ID:
   - Check `supabase/config.toml`
   - Or check environment variables
   - Or check existing type generation scripts
4. Identify which database types file is actively imported (grep imports)

#### Phase 2: Generate New Types (15 min)
1. Run the type generation command:
   ```bash
   supabase gen types typescript --project-id <project-id> > lib/database.types.ts
   ```
2. If there's a `.database.types.new.ts` file, compare to see what changed
3. Document the differences between old and new types

#### Phase 3: Update Imports and References (30 min)
1. Search for all files importing from `lib/database.types.ts`:
   ```bash
   rg "from ['\"].*database\.types" --type ts --type tsx
   ```
2. Update any hardcoded type references that might have changed
3. Check for any manual type extensions that need to be preserved

#### Phase 4: Verify Type Safety (30 min)
1. Run TypeScript type checking:
   ```bash
   npm run type-check
   ```
2. Address any remaining type errors
3. Focus on the critical errors first (Dashboard, Profile, Requests, Auth, Admin)
4. Common issues to fix:
   - Renamed tables or columns
   - Changed nullability constraints
   - Added/removed fields in interfaces

#### Phase 5: Test (15 min)
1. Build the application to ensure types are valid:
   ```bash
   npm run build
   ```
2. Test key areas that were showing errors:
   - Dashboard page loads
   - Profile page works
   - Help requests display
   - Admin features accessible
3. Verify no new runtime errors introduced

### Acceptance Criteria

1. ✅ TypeScript compilation passes with 0 errors (or only non-critical warnings)
2. ✅ All critical errors resolved (Dashboard, Profile, Requests, Auth, Admin)
3. ✅ `lib/database.types.ts` matches current database schema
4. ✅ Production build succeeds without type errors
5. ✅ Key pages load without runtime type errors
6. ✅ Type coverage includes all new tables (calendar_events, community_updates, etc.)

### Files to Modify

1. `lib/database.types.ts` - Regenerate from database schema
2. Files importing from database types - Update references if needed
3. Any files with manual type extensions - Ensure compatibility

### Files to Read (Analysis)

1. `lib/database.types.ts`
2. `lib/database.types.new.ts` (if exists)
3. `supabase/config.toml` - For project ID
4. `package.json` - Check for type generation scripts

### Testing Strategy

1. **Type check:** Run `npm run type-check` to verify all errors resolved
2. **Build test:** Run `npm run build` to ensure production build works
3. **Runtime test:** Test key pages (Dashboard, Profile, Requests, Admin)
4. **Database sync test:** Verify types match actual database schema

### Dependencies

- **Can be done in parallel:** This fix is independent of middleware and integration tests
- **No blocking:** Does not block or depend on other critical fixes

### Potential Risks & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Manual type edits in database.types.ts will be overwritten | Medium | Medium | Check for manual edits before regeneration, preserve if needed |
| New types break existing code (e.g., stricter nullability) | Low | High | Run type-check after regeneration, fix any issues |
| Wrong project ID used for generation | Low | High | Verify project ID from multiple sources before generation |
| Database schema and migrations are out of sync | Low | High | Run migrations first if needed: `supabase db reset` |

### Rollback Plan

If the new types cause issues:
1. Keep backup of original `lib/database.types.ts`
2. Revert to original types
3. Investigate specific type changes causing issues
4. Apply targeted fixes instead of full regeneration

### Additional Context

- This is a quick win that can be done in parallel with middleware fix
- Type safety is critical for catching bugs early
- The 130+ errors suggest the types are significantly out of date
- Supabase generates types directly from the PostgreSQL schema
- Look for patterns like: `Property 'X' does not exist on type 'never'` - these indicate missing table definitions

### Questions for the Agent

1. Should we also regenerate `database.types.new.ts` if it exists?
2. Are there any manual type extensions that need to be preserved?
3. Should we add a script to automate type generation in the future?

### Success Metrics

- Type check passes: `npm run type-check` returns 0 errors
- Critical errors in Dashboard, Profile, Requests, Auth, Admin: 0
- Production build succeeds without type errors
