# Fix Plan: Middleware Edge Runtime Compatibility Error

> Generated by @prompt-builder on 2025-12-27
> Priority: CRITICAL (Complete Blocker)
> Estimated Fix Time: 2-4 hours

## Original Issue

**Error:** `ReferenceError: exports is not defined in .next/server/supabase.js:9`
**Impact:** All protected routes (/dashboard, /requests, /messages, /profile) return 500 errors
**Root Cause:** CommonJS module (@supabase/supabase-js) is being bundled for Edge Runtime (ESM), Webpack creates `exports.id = "supabase"` pattern, but `exports` doesn't exist in ESM scope

## Root Cause Analysis

The issue stems from a mismatch between runtime environments:

1. **middleware.ts** runs in **Edge Runtime** (ESM-only, no Node.js APIs)
2. `/lib/supabase/admin.ts` imports `@supabase/supabase-js` (CommonJS module)
3. Webpack bundles CommonJS into ESM but references `exports` global which doesn't exist in Edge Runtime
4. **Root conflict:** `@supabase/supabase-js` (full-featured, Node.js-compatible) vs `@supabase/ssr` (lightweight, Edge-compatible)

The current middleware likely imports the admin client designed for server components, but Edge Runtime requires the SSR-compatible client.

## Target Agent

`@api-designer` - Middleware and server-side integration, Edge Runtime expertise

---

## Prompt

### Problem Statement

The middleware.ts file is causing a runtime error because it imports a Supabase client that uses CommonJS modules incompatible with Edge Runtime. All protected routes return 500 errors due to this issue.

### Technical Context

- **Current setup:** middleware.ts imports from `/lib/supabase/admin.ts`
- **admin.ts** likely uses `@supabase/supabase-js` (CommonJS, Node.js-compatible)
- **middleware.ts** uses `export { auth as middleware }` which requires Edge Runtime
- **Edge Runtime constraints:** ESM-only, no Node.js APIs, lightweight
- **Solution direction:** Use `@supabase/ssr` package for Edge Runtime compatibility

### Implementation Requirements

#### Phase 1: Analyze Current Implementation (30 min)
1. Read `middleware.ts` to understand current Supabase usage
2. Read `/lib/supabase/admin.ts` to see how Supabase client is created
3. Read `/lib/supabase/server.ts` (if exists) to see server component pattern
4. Check if `@supabase/ssr` is already installed
5. Document exactly which Supabase methods are being used in middleware (getUser, refreshSession, etc.)

#### Phase 2: Create Edge-Compatible Supabase Client (45 min)
1. Create `/lib/supabase/edge.ts` if it doesn't exist
2. Use `@supabase/ssr` package to create Edge Runtime-compatible client
3. Example pattern:
   ```typescript
   import { createServerClient } from '@supabase/ssr';
   import { NextResponse } from 'next/server';
   import type { NextRequest } from 'next/server';

   export function createEdgeClient(request: NextRequest) {
     let response = NextResponse.next({
       request: { headers: request.headers },
     });

     const supabase = createServerClient(
       process.env.NEXT_PUBLIC_SUPABASE_URL!,
       process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
       {
         cookies: {
           getAll() { return request.cookies.getAll(); },
           setAll(cookiesToSet) {
             cookiesToSet.forEach(({ name, value, options }) => {
               request.cookies.set(name, value);
               response.cookies.set(name, value, options);
             });
           },
         },
       }
     );

     return { supabase, response };
   }
   ```
4. Ensure the client only uses Edge-compatible methods (no Node.js APIs)

#### Phase 3: Refactor Middleware (45 min)
1. Update `middleware.ts` to use the Edge-compatible client
2. Keep the same middleware logic (auth checks, protected routes, etc.)
3. Only change the Supabase client creation/usage
4. Ensure the middleware still correctly handles:
   - Session validation
   - Protected route access control
   - Redirect to login for unauthenticated users
   - Session refresh logic (if present)

#### Phase 4: Configure Build (30 min)
1. Verify `next.config.js` has appropriate Edge Runtime settings
2. May need to add webpack configuration if CommonJS issues persist:
   ```javascript
   // next.config.js
   experimental: {
     serverComponentsExternalPackages: ['@supabase/supabase-js'],
   }
   ```
3. Consider adding `@supabase/supabase-js` to serverComponentsExternalPackages if needed

#### Phase 5: Test (60 min)
1. Build the application: `npm run build`
2. Check that `.next/server/middleware.js` generates without errors
3. Test protected routes in development:
   - Navigate to /dashboard (should redirect to /login if not authenticated)
   - Login and verify dashboard loads
   - Test /requests, /messages, /profile
4. Verify middleware logs show no runtime errors
5. Check Edge Runtime is being used (verified via Next.js console output)

### Acceptance Criteria

1. ✅ Production build succeeds without middleware errors
2. ✅ All protected routes (/dashboard, /requests, /messages, /profile) load successfully when authenticated
3. ✅ Middleware correctly redirects unauthenticated users to /login
4. ✅ No `ReferenceError: exports is not defined` errors in build or runtime
5. ✅ Middleware uses Edge Runtime (verified via Next.js console)
6. ✅ Session validation and refresh logic works correctly
7. ✅ TypeScript compilation passes with no errors in middleware

### Files to Modify

1. `middleware.ts` - Update to use Edge-compatible Supabase client
2. `/lib/supabase/edge.ts` - Create new file (or update if exists)
3. `/lib/supabase/server.ts` - Reference for server component pattern (read-only)
4. `next.config.js` - May need webpack configuration updates

### Files to Read (Analysis)

1. `middleware.ts`
2. `/lib/supabase/admin.ts`
3. `/lib/supabase/server.ts`
4. `package.json` - Check installed Supabase packages

### Testing Strategy

1. **Unit test (if possible):** Test middleware function directly with mock requests
2. **Integration test:** Test auth flow in development environment
3. **Build test:** Verify production build succeeds
4. **Runtime test:** Verify middleware logs no errors
5. **User journey test:** Login → Navigate to protected route

### Dependencies

- **None:** This fix has no dependencies on other critical issues
- **Blocks:** Cannot test user journeys for protected routes until this is fixed

### Potential Risks & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| @supabase/ssr missing methods used in current middleware | Medium | Medium | Check required methods in Phase 1, implement workarounds if needed |
| Session refresh logic incompatible with Edge client | Low | High | Thoroughly test session refresh after refactor |
| Webpack configuration changes break other parts | Low | Low | Test full build after config changes |
| Edge Runtime has other limitations not discovered yet | Medium | Medium | Test all middleware functionality thoroughly |

### Rollback Plan

If the fix causes issues:
1. Keep the original `middleware.ts` backed up
2. Revert to original middleware
3. Alternative approach: Use Node.js runtime for middleware (less ideal but functional)

### Next Steps After Fix

1. Once middleware is fixed, proceed with database types regeneration
2. Then fix integration tests (which depend on protected routes working)
3. Finally fix admin CMS types

### Additional Context

- This is the #1 blocker - must fix first before anything else
- The error pattern suggests a fundamental bundling issue, not just a simple import problem
- Edge Runtime is critical for Next.js 14 performance, so fixing this properly is essential
- The `@supabase/ssr` package is specifically designed for this use case
